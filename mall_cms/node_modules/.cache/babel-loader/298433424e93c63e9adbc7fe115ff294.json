{"ast":null,"code":"import _objectSpread from \"/Users/zhahn/Documents/Hahn/\\u81EA\\u8003/\\u9879\\u76EE/mall_cms/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _createForOfIteratorHelper from \"/Users/zhahn/Documents/Hahn/\\u81EA\\u8003/\\u9879\\u76EE/mall_cms/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport _asyncToGenerator from \"/Users/zhahn/Documents/Hahn/\\u81EA\\u8003/\\u9879\\u76EE/mall_cms/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.array.map.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport \"core-js/modules/es.array.filter.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"regenerator-runtime/runtime.js\";\nimport Spu from '@/model/spu';\nimport Sku from '@/model/sku';\nimport SpecKey from '@/model/spec-key';\nimport SpecValue from '@/model/spec-value';\nimport UploadImgs from '@/component/base/upload-image';\nexport default {\n  components: {\n    UploadImgs: UploadImgs\n  },\n  props: {\n    isCreate: {\n      type: Boolean,\n      default: false\n    },\n    skuId: {\n      type: String,\n      default: null\n    }\n  },\n  data: function data() {\n    return {\n      form: {\n        title: '',\n        online: 1,\n        price: 0,\n        rate_price: null,\n        currency: null,\n        code: null,\n        stock: null,\n        img: null\n      },\n      rules: {\n        minWidth: 10,\n        minHeight: 10,\n        maxSize: 5\n      },\n      radio: 1,\n      discount_price_kernel: null,\n      initData: [],\n      maxNum: 1,\n      saled: true,\n      spuState: '',\n      spuList: [],\n      specs: [],\n      specKeys: []\n    };\n  },\n  watch: {\n    saled: function saled(val) {\n      this.form.online = val ? 1 : 0;\n    },\n    discount_price_kernel: function discount_price_kernel(val) {\n      switch (this.radio) {\n        case 1:\n          this.form.rate_price = null;\n          break;\n\n        case 2:\n          this.form.rate_price = val;\n          break;\n\n        case 3:\n          // eslint-disable-next-line\n          var rate = parseFloat(val);\n          this.form.rate_price = this.form.price * rate;\n          break;\n\n        default:\n          this.form.rate_price = null;\n      }\n    }\n  },\n  created: function created() {\n    var _this = this;\n\n    return _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n      return regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _this.$nextTick( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n                var res, initData;\n                return regeneratorRuntime.wrap(function _callee$(_context) {\n                  while (1) {\n                    switch (_context.prev = _context.next) {\n                      case 0:\n                        if (_this.isCreate) {\n                          _context.next = 11;\n                          break;\n                        }\n\n                        _context.next = 3;\n                        return Sku.getSkuDetail(_this.skuId);\n\n                      case 3:\n                        res = _context.sent;\n                        _this.form = res;\n                        initData = [{\n                          id: res.id,\n                          display: res.img\n                        }];\n                        _this.saled = res.online === 1;\n                        _this.initData = initData;\n                        _this.spuState = res.spu_name;\n                        _context.next = 11;\n                        return _this.loadKeyAndValues(res.spu_id);\n\n                      case 11:\n                      case \"end\":\n                        return _context.stop();\n                    }\n                  }\n                }, _callee);\n              })));\n\n            case 1:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }))();\n  },\n  methods: {\n    loadKeyAndValues: function loadKeyAndValues(spuId) {\n      var _this2 = this;\n\n      return _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {\n        var specKeys, _iterator, _step, specKeyy, ttmp;\n\n        return regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return SpecKey.getBySpuId(spuId);\n\n              case 2:\n                specKeys = _context3.sent;\n                _this2.specKeys = specKeys; // eslint-disable-next-line no-unused-vars\n\n                _iterator = _createForOfIteratorHelper(specKeys);\n                _context3.prev = 5;\n\n                _iterator.s();\n\n              case 7:\n                if ((_step = _iterator.n()).done) {\n                  _context3.next = 15;\n                  break;\n                }\n\n                specKeyy = _step.value;\n                _context3.next = 11;\n                return Sku.getSpecValueId(_this2.skuId, specKeyy.id);\n\n              case 11:\n                ttmp = _context3.sent;\n\n                _this2.specs.push([ttmp.value_id]);\n\n              case 13:\n                _context3.next = 7;\n                break;\n\n              case 15:\n                _context3.next = 20;\n                break;\n\n              case 17:\n                _context3.prev = 17;\n                _context3.t0 = _context3[\"catch\"](5);\n\n                _iterator.e(_context3.t0);\n\n              case 20:\n                _context3.prev = 20;\n\n                _iterator.f();\n\n                return _context3.finish(20);\n\n              case 23:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, null, [[5, 17, 20, 23]]);\n      }))();\n    },\n    // eslint-disable-next-line\n    submitForm: function submitForm(formName) {\n      var _this3 = this;\n\n      return _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee5() {\n        var postData, selectors, i, spec, specKeyTmp, tmp, res;\n        return regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                _context5.next = 2;\n                return _this3.getValue();\n\n              case 2:\n                _context5.prev = 2;\n                postData = _objectSpread({}, _this3.form);\n                selectors = [];\n\n                for (i = 0; i < _this3.specs.length; i++) {\n                  spec = _this3.specs[i];\n                  specKeyTmp = _this3.specKeys[i];\n                  tmp = {\n                    key_id: specKeyTmp.id,\n                    value_id: spec[0]\n                  };\n                  selectors.push(tmp);\n                }\n\n                postData.selectors = selectors;\n\n                if (!_this3.isCreate) {\n                  _context5.next = 13;\n                  break;\n                }\n\n                _context5.next = 10;\n                return Sku.addSku(postData);\n\n              case 10:\n                res = _context5.sent;\n                _context5.next = 16;\n                break;\n\n              case 13:\n                _context5.next = 15;\n                return Sku.editSku(_this3.skuId, postData);\n\n              case 15:\n                res = _context5.sent;\n\n              case 16:\n                if (res.code < window.MAX_SUCCESS_CODE) {\n                  _this3.$message.success(\"\".concat(res.message)); // this.resetForm(formName)\n\n\n                  _this3.$confirm('是否返回上一页?', '提示', {\n                    confirmButtonText: '是',\n                    cancelButtonText: '否',\n                    type: 'info'\n                  }).then( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee4() {\n                    return regeneratorRuntime.wrap(function _callee4$(_context4) {\n                      while (1) {\n                        switch (_context4.prev = _context4.next) {\n                          case 0:\n                            _this3.$emit('editClose');\n\n                          case 1:\n                          case \"end\":\n                            return _context4.stop();\n                        }\n                      }\n                    }, _callee4);\n                  })));\n                }\n\n                _context5.next = 22;\n                break;\n\n              case 19:\n                _context5.prev = 19;\n                _context5.t0 = _context5[\"catch\"](2);\n                console.error(_context5.t0);\n\n              case 22:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, null, [[2, 19]]);\n      }))();\n    },\n    makeProps: function makeProps(key_id) {\n      return {\n        lazy: true,\n        lazyLoad: function lazyLoad(node, resolve) {\n          return _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee6() {\n            var level, suggestions, nodes;\n            return regeneratorRuntime.wrap(function _callee6$(_context6) {\n              while (1) {\n                switch (_context6.prev = _context6.next) {\n                  case 0:\n                    level = node.level;\n                    _context6.next = 3;\n                    return SpecValue.getBySpecKeyId(key_id);\n\n                  case 3:\n                    suggestions = _context6.sent;\n                    nodes = suggestions.map(function (item) {\n                      return {\n                        value: item.id,\n                        label: \"\".concat(item.id, \" - \").concat(item.value),\n                        leaf: level >= 0\n                      };\n                    });\n                    resolve(nodes);\n\n                  case 6:\n                  case \"end\":\n                    return _context6.stop();\n                }\n              }\n            }, _callee6);\n          }))();\n        }\n      };\n    },\n    resetForm: function resetForm(formName) {\n      this.$refs[formName].resetFields();\n    },\n    querySpuSearch: function querySpuSearch(queryString, cb) {\n      // eslint-disable-next-line\n      var suggestions = this.spuList;\n      var results = queryString ? suggestions.filter(this.createSpuFilter(queryString)) : suggestions;\n      cb(results);\n    },\n    createSpuFilter: function createSpuFilter(queryString) {\n      // eslint-disable-next-line\n      return function (suggestion) {\n        return suggestion.title.toLowerCase().indexOf(queryString.toLowerCase()) === 0;\n      };\n    },\n    handleSpuSelect: function handleSpuSelect(item) {\n      this.spuState = item.title;\n      this.form.spu_id = item.id;\n      this.loadKeyAndValues(item.id);\n    },\n    getValue: function getValue() {\n      var _this4 = this;\n\n      return _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee7() {\n        var val;\n        return regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.next = 2;\n                return _this4.$refs.uploadEle.getValue();\n\n              case 2:\n                val = _context7.sent;\n\n                if (val && val.length > 0) {\n                  _this4.form.img = val[0].display;\n                }\n\n              case 4:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7);\n      }))();\n    },\n    back: function back() {\n      this.$emit('editClose');\n    },\n    loadSpuSuggestions: function loadSpuSuggestions() {\n      var _this5 = this;\n\n      return _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee8() {\n        return regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                if (!(_this5.spuList.length > 0)) {\n                  _context8.next = 2;\n                  break;\n                }\n\n                return _context8.abrupt(\"return\");\n\n              case 2:\n                _context8.prev = 2;\n                _context8.next = 5;\n                return Spu.getList();\n\n              case 5:\n                _this5.spuList = _context8.sent;\n\n                if (_this5.spuList.length === 0) {\n                  _this5.$message.error('未找到SPU建议，请先添加SPU');\n                }\n\n                _context8.next = 13;\n                break;\n\n              case 9:\n                _context8.prev = 9;\n                _context8.t0 = _context8[\"catch\"](2);\n\n                _this5.$message.error('获取SPU建议信息失败');\n\n                console.error(_context8.t0);\n\n              case 13:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, null, [[2, 9]]);\n      }))();\n    }\n  }\n};","map":{"version":3,"sources":["/Users/zhahn/Documents/Hahn/自考/项目/mall_cms/src/view/sku/sku-edit.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div>\n    <sticky-top>\n      <div class=\"title\">\n        <span>{{ isCreate ? '创建SKU' : '更新SKU' }}</span>\n        <span class=\"back\" @click=\"back\"> <i class=\"iconfont icon-fanhui\"></i> 返回 </span>\n        <el-divider></el-divider>\n      </div>\n    </sticky-top>\n    <div class=\"container\">\n      <div class=\"wrap\">\n        <el-row>\n          <el-col :lg=\"16\" :md=\"20\" :sm=\"24\" :xs=\"24\">\n            <el-form :model=\"form\" status-icon ref=\"form\" label-width=\"100px\" @submit.native.prevent>\n              <el-form-item label=\"标题\" prop=\"title\">\n                <el-input size=\"medium\" v-model=\"form.title\" placeholder=\"请填写标题\"></el-input>\n              </el-form-item>\n\n              <el-form-item label=\"价格\" prop=\"price\">\n                <el-input-number v-model=\"form.price\" :precision=\"2\" :step=\"0.1\"></el-input-number>\n              </el-form-item>\n\n              <!-- 折扣价 打折，或者折扣价 -->\n              <el-form-item label=\"折扣价\" prop=\"rate_price\">\n                <el-radio-group v-model=\"radio\">\n                  <el-radio :label=\"1\">无折扣</el-radio>\n                  <el-radio :label=\"2\">折扣价</el-radio>\n                  <el-radio :label=\"3\">打折</el-radio>\n                </el-radio-group>\n                <el-input\n                  :disabled=\"radio === 1\"\n                  style=\"margin:5px 0;\"\n                  size=\"medium\"\n                  v-model=\"discount_price_kernel\"\n                ></el-input>\n                <el-input disabled size=\"medium\" v-model=\"form.rate_price\"></el-input>\n              </el-form-item>\n\n              <el-form-item v-if=\"!isCreate\" label=\"编码\" prop=\"code\">\n                <el-input disabled size=\"medium\" v-model=\"form.code\" placeholder=\"请填写编码\"></el-input>\n              </el-form-item>\n\n              <el-form-item label=\"库存\" prop=\"stock\">\n                <el-input-number v-model=\"form.stock\" :step=\"1\" step-strictly></el-input-number>\n              </el-form-item>\n\n              <el-form-item label=\"SPU\" prop=\"spu_id\">\n                <el-autocomplete\n                  @focus=\"loadSpuSuggestions\"\n                  popper-class=\"my-autocomplete\"\n                  class=\"inline-input\"\n                  v-model=\"spuState\"\n                  :fetch-suggestions=\"querySpuSearch\"\n                  placeholder=\"请填写所属SPU\"\n                  @select=\"handleSpuSelect\"\n                >\n                  <template #default=\"{ item }\">\n                    <span class=\"id\">{{ item.id }}</span>\n                    <span class=\"name\">{{ item.title }}</span>\n                  </template>\n                </el-autocomplete>\n              </el-form-item>\n\n              <el-form-item label=\"是否上架\">\n                <el-switch\n                  size=\"medium\"\n                  v-model=\"saled\"\n                  active-color=\"#13ce66\"\n                  inactive-color=\"#ff4949\"\n                  active-text=\"上架\"\n                  inactive-text=\"下架\"\n                ></el-switch>\n              </el-form-item>\n\n              <el-form-item label=\"图片\" prop=\"img\">\n                <upload-imgs :max-num=\"maxNum\" ref=\"uploadEle\" :value=\"initData\" />\n              </el-form-item>\n\n              <el-form-item\n                v-for=\"(specKey, index) in specKeys\"\n                :key=\"index\"\n                :label=\"`选择${specKey.name}`\"\n                :prop=\"specKey.name\"\n              >\n                <el-cascader\n                  :placeholder=\"`选择${specKey.name}`\"\n                  v-model=\"specs[index]\"\n                  :props=\"makeProps(specKey.id)\"\n                ></el-cascader>\n              </el-form-item>\n\n              <el-form-item class=\"submit\">\n                <el-button\n                  v-permission=\"{ permission: ['创建SKU', '更新SKU'], type: 'disabled' }\"\n                  type=\"primary\"\n                  @click=\"submitForm('form')\"\n                  >保 存</el-button\n                >\n                <!-- <el-button @click=\"resetForm('form')\">重 置</el-button> -->\n              </el-form-item>\n            </el-form>\n          </el-col>\n        </el-row>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport Spu from '@/model/spu'\nimport Sku from '@/model/sku'\nimport SpecKey from '@/model/spec-key'\nimport SpecValue from '@/model/spec-value'\nimport UploadImgs from '@/component/base/upload-image'\n\nexport default {\n  components: {\n    UploadImgs,\n  },\n  props: {\n    isCreate: {\n      type: Boolean,\n      default: false,\n    },\n    skuId: {\n      type: String,\n      default: null,\n    },\n  },\n  data() {\n    return {\n      form: {\n        title: '',\n        online: 1,\n        price: 0,\n        rate_price: null,\n        currency: null,\n        code: null,\n        stock: null,\n        img: null,\n      },\n      rules: {\n        minWidth: 10,\n        minHeight: 10,\n        maxSize: 5,\n      },\n      radio: 1,\n      discount_price_kernel: null,\n      initData: [],\n      maxNum: 1,\n      saled: true,\n      spuState: '',\n      spuList: [],\n      specs: [],\n      specKeys: [],\n    }\n  },\n  watch: {\n    saled(val) {\n      this.form.online = val ? 1 : 0\n    },\n    discount_price_kernel(val) {\n      switch (this.radio) {\n        case 1:\n          this.form.rate_price = null\n          break\n        case 2:\n          this.form.rate_price = val\n          break\n        case 3:\n          // eslint-disable-next-line\n          const rate = parseFloat(val)\n          this.form.rate_price = this.form.price * rate\n          break\n        default:\n          this.form.rate_price = null\n      }\n    },\n  },\n  async created() {\n    this.$nextTick(async () => {\n      if (!this.isCreate) {\n        const res = await Sku.getSkuDetail(this.skuId)\n        this.form = res\n        const initData = [\n          {\n            id: res.id,\n            display: res.img,\n          },\n        ]\n        this.saled = res.online === 1\n        this.initData = initData\n        this.spuState = res.spu_name\n        await this.loadKeyAndValues(res.spu_id)\n      }\n    })\n  },\n  methods: {\n    async loadKeyAndValues(spuId) {\n      const specKeys = await SpecKey.getBySpuId(spuId)\n      this.specKeys = specKeys\n      // eslint-disable-next-line no-unused-vars\n      for (const specKeyy of specKeys) {\n        // eslint-disable-next-line\n        const ttmp = await Sku.getSpecValueId(this.skuId, specKeyy.id)\n        this.specs.push([ttmp.value_id])\n      }\n    },\n    // eslint-disable-next-line\n    async submitForm(formName) {\n      await this.getValue()\n      try {\n        const postData = { ...this.form }\n        const selectors = []\n        for (let i = 0; i < this.specs.length; i++) {\n          const spec = this.specs[i]\n          const specKeyTmp = this.specKeys[i]\n          const tmp = {\n            key_id: specKeyTmp.id,\n            value_id: spec[0],\n          }\n          selectors.push(tmp)\n        }\n        postData.selectors = selectors\n        let res\n        if (this.isCreate) {\n          res = await Sku.addSku(postData)\n        } else {\n          res = await Sku.editSku(this.skuId, postData)\n        }\n        if (res.code < window.MAX_SUCCESS_CODE) {\n          this.$message.success(`${res.message}`)\n          // this.resetForm(formName)\n          this.$confirm('是否返回上一页?', '提示', {\n            confirmButtonText: '是',\n            cancelButtonText: '否',\n            type: 'info',\n          }).then(async () => {\n            this.$emit('editClose')\n          })\n        }\n      } catch (error) {\n        console.error(error)\n      }\n    },\n    makeProps(key_id) {\n      return {\n        lazy: true,\n        async lazyLoad(node, resolve) {\n          const { level } = node\n          const suggestions = await SpecValue.getBySpecKeyId(key_id)\n          const nodes = suggestions.map(item => ({\n            value: item.id,\n            label: `${item.id} - ${item.value}`,\n            leaf: level >= 0,\n          }))\n          resolve(nodes)\n        },\n      }\n    },\n    resetForm(formName) {\n      this.$refs[formName].resetFields()\n    },\n    querySpuSearch(queryString, cb) {\n      // eslint-disable-next-line\n      const suggestions = this.spuList\n      const results = queryString ? suggestions.filter(this.createSpuFilter(queryString)) : suggestions\n      cb(results)\n    },\n    createSpuFilter(queryString) {\n      // eslint-disable-next-line\n      return suggestion => {\n        return suggestion.title.toLowerCase().indexOf(queryString.toLowerCase()) === 0\n      }\n    },\n    handleSpuSelect(item) {\n      this.spuState = item.title\n      this.form.spu_id = item.id\n      this.loadKeyAndValues(item.id)\n    },\n    async getValue() {\n      const val = await this.$refs.uploadEle.getValue()\n      if (val && val.length > 0) {\n        this.form.img = val[0].display\n      }\n    },\n    back() {\n      this.$emit('editClose')\n    },\n    async loadSpuSuggestions() {\n      if (this.spuList.length > 0) {\n        return\n      }\n      try {\n        this.spuList = await Spu.getList()\n        if (this.spuList.length === 0) {\n          this.$message.error('未找到SPU建议，请先添加SPU')\n        }\n      } catch (error) {\n        this.$message.error('获取SPU建议信息失败')\n        console.error(error)\n      }\n    },\n  },\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.el-divider--horizontal {\n  margin: 0;\n}\n\n.container {\n  .title {\n    height: 59px;\n    line-height: 59px;\n    color: $parent-title-color;\n    font-size: 16px;\n    font-weight: 500;\n    text-indent: 40px;\n\n    .back {\n      float: right;\n      margin-right: 40px;\n      cursor: pointer;\n    }\n  }\n\n  .wrap {\n    padding: 20px;\n  }\n\n  .submit {\n    float: left;\n  }\n}\n\n.my-autocomplete {\n  li {\n    line-height: normal;\n    padding: 7px;\n    display: inline-flex;\n    align-content: space-around;\n    .name {\n      text-overflow: ellipsis;\n      overflow: hidden;\n    }\n    .id {\n      margin-right: 15px;\n      font-size: 12px;\n      color: #b4b4b4;\n    }\n\n    .highlighted .addr {\n      color: #ddd;\n    }\n  }\n}\n.white-color {\n  background-color: #fff;\n}\n\n.input-with-select .el-input-group__prepend {\n  background-color: #fff;\n}\n</style>\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}
{"ast":null,"code":"import _objectSpread from \"/Users/zhahn/Documents/Hahn/\\u81EA\\u8003/mall/mall_cms/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _asyncToGenerator from \"/Users/zhahn/Documents/Hahn/\\u81EA\\u8003/mall/mall_cms/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"regenerator-runtime/runtime.js\";\nimport \"core-js/modules/es.array.includes.js\";\nimport \"core-js/modules/es.string.includes.js\";\nimport \"core-js/modules/es.string.trim.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport { useStore } from 'vuex';\nimport { computed, ref, reactive, watch, onMounted, toRefs } from 'vue';\nimport logModel from 'lin/model/log';\nimport { searchLogKeyword } from 'lin/util/search';\nimport LinSearch from '@/component/base/search/lin-search';\nimport LinDatePicker from '@/component/base/date-picker/lin-date-picker';\nexport default {\n  components: {\n    LinSearch: LinSearch,\n    LinDatePicker: LinDatePicker\n  },\n  setup: function setup() {\n    // originally data properties\n    var store = useStore();\n    var user = computed(function () {\n      return store.getters.user;\n    });\n    var permissions = computed(function () {\n      return store.getters.permissions;\n    });\n    var count = 10;\n    var logs = ref([]);\n    var users = ref([]);\n    var loading = ref(false);\n    var isSearch = ref(false);\n    var finished = ref(false);\n    var searchDateDom = ref();\n    var searchKeywordDom = ref();\n    /**\n     * Part 1\n     * 日志页面初始化\n     */\n\n    var initPage = /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        var res;\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.prev = 0;\n                loading.value = true;\n\n                if (!(user.value.admin || permissions.value.includes('查询日志记录的用户'))) {\n                  _context.next = 6;\n                  break;\n                }\n\n                _context.next = 5;\n                return logModel.getLoggedUsers({});\n\n              case 5:\n                users.value = _context.sent;\n\n              case 6:\n                _context.next = 8;\n                return logModel.getLogs({\n                  page: 0,\n                  count: count\n                });\n\n              case 8:\n                res = _context.sent;\n                logs.value = res.items;\n                loading.value = false;\n                _context.next = 17;\n                break;\n\n              case 13:\n                _context.prev = 13;\n                _context.t0 = _context[\"catch\"](0);\n                loading.value = false;\n                console.error(_context.t0.data);\n\n              case 17:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[0, 13]]);\n      }));\n\n      return function initPage() {\n        return _ref.apply(this, arguments);\n      };\n    }();\n\n    onMounted( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n      return regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return initPage();\n\n            case 2:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    })));\n    /**\n     * Part 2\n     * 根据调解筛选查询日志\n     */\n\n    var search = reactive({\n      keyword: '',\n      searchUser: '',\n      searchKeyword: '',\n      searchDate: [],\n      totalCount: 0\n    });\n\n    var onQueryChange = function onQueryChange(query) {\n      search.searchKeyword = query.trim();\n    };\n\n    var handleDateChange = function handleDateChange(date) {\n      search.searchDate = date;\n    };\n\n    var handleCommand = function handleCommand(currentUser) {\n      search.searchUser = currentUser[0]; // eslint-disable-line\n    }; // 条件检索\n\n\n    var searchPage = /*#__PURE__*/function () {\n      var _ref3 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {\n        var name, res, searchLogs;\n        return regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                logs.value = [];\n                loading.value = true;\n                search.totalCount = 0;\n                finished.value = false;\n                name = search.searchUser === '全部人员' ? '' : search.searchUser;\n                _context3.next = 7;\n                return logModel.searchLogs({\n                  page: 0,\n                  // 初始化\n                  keyword: search.searchKeyword,\n                  name: name,\n                  start: search.searchDate[0],\n                  end: search.searchDate[1]\n                });\n\n              case 7:\n                res = _context3.sent;\n\n                if (res) {\n                  searchLogs = res.items;\n                  search.totalCount = res.total;\n\n                  if (search.searchKeyword) {\n                    searchLogs = searchLogKeyword(search.searchKeyword, searchLogs);\n                  }\n\n                  logs.value = searchLogs;\n                } else {\n                  finished.value = true;\n                }\n\n                isSearch.value = true;\n                loading.value = false;\n\n              case 11:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function searchPage() {\n        return _ref3.apply(this, arguments);\n      };\n    }();\n\n    watch(function () {\n      return search.searchKeyword;\n    }, function (newKeyword) {\n      // 关键字搜索\n      if (newKeyword) {\n        search.keyword = newKeyword;\n\n        if (search.searchUser) {\n          search.keyword = \"\".concat(search.searchUser, \" \").concat(newKeyword);\n        }\n\n        if (search.searchDate.length) {\n          search.keyword = \"\".concat(search.searchUser, \" \").concat(newKeyword, \" \").concat(search.searchDate[0], \"\\u81F3\").concat(search.searchDate[1]);\n        }\n      } else {\n        search.keyword = '';\n\n        if (search.searchUser) {\n          search.keyword = \"\".concat(search.searchUser);\n        }\n\n        if (search.searchDate.length) {\n          search.keyword = \"\".concat(search.searchUser, \" \").concat(search.searchDate[0], \"\\u81F3\").concat(search.searchDate[1]);\n        }\n\n        searchKeywordDom.value.clear();\n      }\n\n      searchPage();\n    }, {\n      lazy: true\n    });\n    watch(function () {\n      return search.searchUser;\n    }, function (newUser) {\n      // 用户搜索\n      search.keyword = newUser;\n\n      if (search.searchKeyword) {\n        search.keyword = \"\".concat(newUser, \" \").concat(search.searchKeyword);\n      }\n\n      if (search.searchDate.length) {\n        search.keyword = \"\".concat(newUser, \" \").concat(search.searchKeyword, \" \").concat(search.searchDate[0], \"\\u81F3\").concat(search.searchDate[1]);\n      }\n\n      searchPage();\n    }, {\n      lazy: true\n    });\n    watch(function () {\n      return search.searchDate;\n    }, function (newDate) {\n      if (newDate !== null && newDate !== void 0 && newDate.length) {\n        search.keyword = \"\".concat(newDate[0], \"\\u81F3\").concat(newDate[1]);\n\n        if (search.searchUser) {\n          search.keyword = \"\".concat(search.searchUser, \" \").concat(newDate[0], \"\\u81F3\").concat(newDate[1]);\n        }\n\n        if (search.searchKeyword) {\n          search.keyword = \"\".concat(search.searchUser, \" \").concat(search.searchKeyword, \" \").concat(newDate[0], \"\\u81F3\").concat(newDate[1]);\n        }\n      } else {\n        search.keyword = '';\n        isSearch.value = false;\n\n        if (search.searchUser) {\n          search.keyword = \"\".concat(search.searchUser);\n        }\n\n        if (search.searchKeyword) {\n          search.keyword = \"\".concat(search.searchUser, \" \").concat(search.searchKeyword);\n        }\n\n        searchDateDom.value.clear();\n      }\n\n      searchPage();\n    }, {\n      lazy: true\n    });\n\n    var backInit = /*#__PURE__*/function () {\n      var _ref4 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee4() {\n        return regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                search.searchUser = '';\n                search.searchKeyword = '';\n                search.searchDate = [];\n                search.keyword = '';\n                search.totalCount = 0;\n                logs.value = [];\n                isSearch.value = false;\n                _context4.next = 9;\n                return initPage();\n\n              case 9:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      }));\n\n      return function backInit() {\n        return _ref4.apply(this, arguments);\n      };\n    }();\n    /**\n     * Part 3\n     * 翻页处理\n     */\n\n\n    var more = ref(false);\n\n    var nextPage = /*#__PURE__*/function () {\n      var _ref5 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee5() {\n        var res, moreLogs;\n        return regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                more.value = true;\n                _context5.prev = 1;\n\n                if (!isSearch.value) {\n                  _context5.next = 8;\n                  break;\n                }\n\n                _context5.next = 5;\n                return logModel.moreSearchPage();\n\n              case 5:\n                res = _context5.sent;\n                _context5.next = 11;\n                break;\n\n              case 8:\n                _context5.next = 10;\n                return logModel.moreLogPage();\n\n              case 10:\n                res = _context5.sent;\n\n              case 11:\n                moreLogs = res.items;\n\n                if (moreLogs.length) {\n                  _context5.next = 16;\n                  break;\n                }\n\n                finished.value = true;\n                _context5.next = 21;\n                break;\n\n              case 16:\n                if (!(isSearch.value && search.searchKeyword)) {\n                  _context5.next = 20;\n                  break;\n                }\n\n                _context5.next = 19;\n                return searchLogKeyword(search.searchKeyword, moreLogs);\n\n              case 19:\n                moreLogs = _context5.sent;\n\n              case 20:\n                logs.value = logs.value.concat(moreLogs);\n\n              case 21:\n                more.value = false;\n                _context5.next = 29;\n                break;\n\n              case 24:\n                _context5.prev = 24;\n                _context5.t0 = _context5[\"catch\"](1);\n                console.error('error', _context5.t0);\n\n                if (_context5.t0.data.code === 10020) {\n                  finished.value = true;\n                }\n\n                more.value = false;\n\n              case 29:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, null, [[1, 24]]);\n      }));\n\n      return function nextPage() {\n        return _ref5.apply(this, arguments);\n      };\n    }();\n\n    return _objectSpread({\n      users: users,\n      logs: logs,\n      more: more,\n      count: count,\n      loading: loading,\n      finished: finished,\n      backInit: backInit,\n      nextPage: nextPage,\n      isSearch: isSearch,\n      onQueryChange: onQueryChange,\n      handleCommand: handleCommand,\n      searchDateDom: searchDateDom,\n      handleDateChange: handleDateChange,\n      searchKeywordDom: searchKeywordDom\n    }, toRefs(search));\n  }\n};","map":{"version":3,"sources":["/Users/zhahn/Documents/Hahn/自考/mall/mall_cms/src/view/log/log.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div class=\"log\">\n    <sticky-top>\n      <div class=\"log-header\">\n        <div class=\"header-left\"><p class=\"title\">日志信息</p></div>\n        <!--<div class=\"header-right\" v-permission=\"'搜索日志'\">-->\n        <div class=\"header-right\" v-permission=\"'搜索日志'\">\n          <lin-search @query=\"onQueryChange\" ref=\"searchKeywordDom\" />\n          <!--<el-dropdown style=\"margin: 0 10px\" @command=\"handleCommand\" v-permission=\"'查询日志记录的用户'\">-->\n          <el-dropdown style=\"margin: 0 10px\" @command=\"handleCommand\" v-permission=\"'查询日志记录的用户'\">\n            <el-button>\n              {{ searchUser ? searchUser : '全部人员' }} <i class=\"el-icon-arrow-down el-icon--right\"></i>\n            </el-button>\n            <template #dropdown>\n              <el-dropdown-menu>\n                <el-dropdown-item :command=\"['全部人员']\">全部人员</el-dropdown-item>\n                <el-dropdown-item\n                  icon=\"el-icon-user-solid\"\n                  v-for=\"(user, index) in users.items\"\n                  :key=\"index\"\n                  :command=\"[user]\"\n                  >{{ user }}\n                </el-dropdown-item>\n              </el-dropdown-menu>\n            </template>\n          </el-dropdown>\n          <lin-date-picker @dateChange=\"handleDateChange\" ref=\"searchDateDom\" class=\"date\"> </lin-date-picker>\n        </div>\n      </div>\n      <el-divider v-if=\"!keyword\"></el-divider>\n    </sticky-top>\n    <transition name=\"fade\">\n      <div class=\"search\" v-if=\"keyword\">\n        <p class=\"search-tip\">\n          搜索“<span class=\"search-keyword\">{{ keyword }}</span\n          >”， 找到 <span class=\"search-num\">{{ totalCount }}</span> 条日志信息\n        </p>\n        <button class=\"search-back\" @click=\"backInit\">返回全部日志</button>\n      </div>\n    </transition>\n    <div class=\"content\" v-loading=\"loading\">\n      <article>\n        <section v-for=\"log in logs\" :key=\"log.id\">\n          <span class=\"point-time\"></span>\n          <aside>\n            <p class=\"things\" v-html=\"log.message\"></p>\n            <p class=\"brief\">\n              <span class=\"text-yellow\">{{ log.username }}</span> {{ $filters.dateTimeFormatter(log.time) }}\n            </p>\n          </aside>\n        </section>\n      </article>\n\n      <div v-if=\"totalCount > count || totalCount === 0\">\n        <div v-if=\"logs?.length\">\n          <el-divider></el-divider>\n          <div class=\"more\" :class=\"{ nothing: finished }\">\n            <i v-if=\"more\" class=\"iconfont icon-loading\"></i>\n            <div v-show=\"!more && !finished\" @click=\"nextPage\">\n              <span>查看更多</span> <i class=\"iconfont icon-gengduo\" style=\"font-size: 14px\"></i>\n            </div>\n            <div v-if=\"finished\">\n              <span>{{ totalCount === 0 ? '暂无数据' : '没有更多数据了' }}</span>\n            </div>\n          </div>\n        </div>\n        <div class=\"nothing\" v-else>暂无日志信息</div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport { useStore } from 'vuex'\nimport { computed, ref, reactive, watch, onMounted, toRefs } from 'vue'\n\nimport logModel from 'lin/model/log'\nimport { searchLogKeyword } from 'lin/util/search'\nimport LinSearch from '@/component/base/search/lin-search'\nimport LinDatePicker from '@/component/base/date-picker/lin-date-picker'\n\nexport default {\n  components: {\n    LinSearch,\n    LinDatePicker,\n  },\n  setup() {\n    // originally data properties\n    const store = useStore()\n    const user = computed(() => store.getters.user)\n    const permissions = computed(() => store.getters.permissions)\n\n    const count = 10\n    const logs = ref([])\n    const users = ref([])\n    const loading = ref(false)\n    const isSearch = ref(false)\n    const finished = ref(false)\n    const searchDateDom = ref()\n    const searchKeywordDom = ref()\n\n    /**\n     * Part 1\n     * 日志页面初始化\n     */\n    const initPage = async () => {\n      try {\n        loading.value = true\n        if (user.value.admin || permissions.value.includes('查询日志记录的用户')) {\n          users.value = await logModel.getLoggedUsers({})\n        }\n        const res = await logModel.getLogs({ page: 0, count })\n        logs.value = res.items\n        loading.value = false\n      } catch (err) {\n        loading.value = false\n        console.error(err.data)\n      }\n    }\n    onMounted(async () => {\n      await initPage()\n    })\n\n    /**\n     * Part 2\n     * 根据调解筛选查询日志\n     */\n    const search = reactive({\n      keyword: '',\n      searchUser: '',\n      searchKeyword: '',\n      searchDate: [],\n      totalCount: 0,\n    })\n\n    const onQueryChange = query => {\n      search.searchKeyword = query.trim()\n    }\n    const handleDateChange = date => {\n      search.searchDate = date\n    }\n    const handleCommand = currentUser => {\n      search.searchUser = currentUser[0] // eslint-disable-line\n    }\n    // 条件检索\n    const searchPage = async () => {\n      logs.value = []\n      loading.value = true\n      search.totalCount = 0\n      finished.value = false\n      const name = search.searchUser === '全部人员' ? '' : search.searchUser\n\n      const res = await logModel.searchLogs({\n        page: 0, // 初始化\n        keyword: search.searchKeyword,\n        name,\n        start: search.searchDate[0],\n        end: search.searchDate[1],\n      })\n      if (res) {\n        let searchLogs = res.items\n        search.totalCount = res.total\n        if (search.searchKeyword) {\n          searchLogs = searchLogKeyword(search.searchKeyword, searchLogs)\n        }\n        logs.value = searchLogs\n      } else {\n        finished.value = true\n      }\n      isSearch.value = true\n      loading.value = false\n    }\n\n    watch(\n      () => search.searchKeyword,\n      newKeyword => {\n        // 关键字搜索\n        if (newKeyword) {\n          search.keyword = newKeyword\n          if (search.searchUser) {\n            search.keyword = `${search.searchUser} ${newKeyword}`\n          }\n          if (search.searchDate.length) {\n            search.keyword = `${search.searchUser} ${newKeyword} ${search.searchDate[0]}至${search.searchDate[1]}`\n          }\n        } else {\n          search.keyword = ''\n          if (search.searchUser) {\n            search.keyword = `${search.searchUser}`\n          }\n          if (search.searchDate.length) {\n            search.keyword = `${search.searchUser} ${search.searchDate[0]}至${search.searchDate[1]}`\n          }\n          searchKeywordDom.value.clear()\n        }\n        searchPage()\n      },\n      { lazy: true },\n    )\n\n    watch(\n      () => search.searchUser,\n      newUser => {\n        // 用户搜索\n        search.keyword = newUser\n        if (search.searchKeyword) {\n          search.keyword = `${newUser} ${search.searchKeyword}`\n        }\n        if (search.searchDate.length) {\n          search.keyword = `${newUser} ${search.searchKeyword} ${search.searchDate[0]}至${search.searchDate[1]}`\n        }\n        searchPage()\n      },\n      { lazy: true },\n    )\n\n    watch(\n      () => search.searchDate,\n      newDate => {\n        if (newDate?.length) {\n          search.keyword = `${newDate[0]}至${newDate[1]}`\n          if (search.searchUser) {\n            search.keyword = `${search.searchUser} ${newDate[0]}至${newDate[1]}`\n          }\n          if (search.searchKeyword) {\n            search.keyword = `${search.searchUser} ${search.searchKeyword} ${newDate[0]}至${newDate[1]}`\n          }\n        } else {\n          search.keyword = ''\n          isSearch.value = false\n          if (search.searchUser) {\n            search.keyword = `${search.searchUser}`\n          }\n          if (search.searchKeyword) {\n            search.keyword = `${search.searchUser} ${search.searchKeyword}`\n          }\n          searchDateDom.value.clear()\n        }\n        searchPage()\n      },\n      { lazy: true },\n    )\n\n    const backInit = async () => {\n      search.searchUser = ''\n      search.searchKeyword = ''\n      search.searchDate = []\n      search.keyword = ''\n      search.totalCount = 0\n      logs.value = []\n      isSearch.value = false\n      await initPage()\n    }\n\n    /**\n     * Part 3\n     * 翻页处理\n     */\n    const more = ref(false)\n    const nextPage = async () => {\n      more.value = true\n      let res\n      try {\n        if (isSearch.value) {\n          res = await logModel.moreSearchPage()\n        } else {\n          res = await logModel.moreLogPage()\n        }\n\n        let moreLogs = res.items\n        if (!moreLogs.length) {\n          finished.value = true\n        } else {\n          if (isSearch.value && search.searchKeyword) {\n            moreLogs = await searchLogKeyword(search.searchKeyword, moreLogs)\n          }\n          logs.value = logs.value.concat(moreLogs)\n        }\n\n        more.value = false\n      } catch (error) {\n        console.error('error', error)\n\n        if (error.data.code === 10020) {\n          finished.value = true\n        }\n        more.value = false\n      }\n    }\n\n    return {\n      users,\n      logs,\n      more,\n      count,\n      loading,\n      finished,\n      backInit,\n      nextPage,\n      isSearch,\n      onQueryChange,\n      handleCommand,\n      searchDateDom,\n      handleDateChange,\n      searchKeywordDom,\n      ...toRefs(search),\n    }\n  },\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.log :v-deep(.el-button) {\n  padding-top: 10px;\n  padding-bottom: 10px;\n}\n.log {\n  .log-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 0 20px;\n    margin-bottom: -24px;\n\n    .header-left {\n      float: left;\n\n      .title {\n        height: 59px;\n        line-height: 59px;\n        color: #4c76af;\n        font-size: 16px;\n        font-weight: 500;\n      }\n    }\n\n    .header-right {\n      float: right;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n  }\n\n  .search {\n    height: 52px;\n    width: 100%;\n    background: rgba(57, 99, 188, 0.1);\n    display: flex;\n    flex-direction: row;\n    justify-content: space-between;\n    margin-top: 24px;\n\n    .search-tip {\n      margin-left: 40px;\n      height: 52px;\n      line-height: 52px;\n      color: #354058;\n      font-size: 14px;\n\n      .search-keyword {\n        color: $theme;\n      }\n\n      .search-num {\n        color: #f4516c;\n      }\n    }\n\n    .search-back {\n      margin: 8px 20px;\n      height: 32px;\n      background: #f4516c;\n      border: none;\n      border-radius: 2px;\n      color: #fff;\n      padding: 0 13px;\n      font-size: 14px;\n      cursor: pointer;\n    }\n  }\n\n  .content {\n    padding: 40px 60px;\n\n    article {\n      position: relative;\n      margin-bottom: -24px;\n\n      section {\n        padding: 0 0 36px;\n        position: relative;\n\n        &:before {\n          content: '';\n          width: 1px;\n          top: 7px;\n          bottom: -17px;\n          left: 10.5px;\n          background: #f3f3f3;\n          position: absolute;\n        }\n\n        &:last-child:before {\n          display: none;\n        }\n\n        .point-time {\n          content: '';\n          position: absolute;\n          width: 10px;\n          height: 10px;\n          top: 2px;\n          left: 10px;\n          background: $theme;\n          margin-left: -4px;\n          border-radius: 50%;\n        }\n\n        time {\n          width: 15%;\n          display: block;\n          position: absolute;\n\n          span {\n            display: block;\n            text-align: right;\n          }\n        }\n\n        aside {\n          color: #45526b;\n          margin-left: 30px;\n\n          .things {\n            font-size: 14px;\n            color: #45526b;\n            margin-bottom: 15px;\n          }\n        }\n\n        .text-yellow {\n          color: #8c98ae;\n          font-size: 14px;\n          line-height: 20px;\n          padding-right: 30px;\n          float: left;\n        }\n\n        .brief {\n          font-size: 14px;\n          color: #c4c9d2;\n          height: 20px;\n          line-height: 20px;\n        }\n      }\n    }\n  }\n\n  .more {\n    height: 40px;\n    line-height: 40px;\n    color: $theme;\n    font-size: 14px;\n    margin-left: 28px;\n    cursor: pointer;\n    &.nothing {\n      cursor: text;\n    }\n\n    .icon-gengduo {\n      display: inline;\n      margin-left: 6px;\n    }\n\n    .icon-loading {\n      &:before {\n        display: inline-block;\n        animation: spin 1s linear infinite;\n      }\n    }\n  }\n}\n.nothing {\n  color: #45526b;\n  font-size: 14px;\n}\n\n@keyframes spin {\n  from {\n    transform: rotate(0deg);\n  }\n\n  to {\n    transform: rotate(360deg);\n  }\n}\n\n@media screen and (max-width: 1000px) {\n  .date {\n    display: none;\n  }\n}\n</style>\n<style>\n.strong {\n  color: #464dd5;\n}\n</style>\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}
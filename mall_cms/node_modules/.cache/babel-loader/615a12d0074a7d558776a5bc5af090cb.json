{"ast":null,"code":"import _asyncToGenerator from \"/Users/zhahn/Documents/Hahn/\\u81EA\\u8003/\\u9879\\u76EE/mall_cms/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"regenerator-runtime/runtime.js\";\nimport { reactive, ref, onMounted, getCurrentInstance } from 'vue';\nimport { useStore } from 'vuex';\nimport { useRouter } from 'vue-router';\nimport axios from 'lin/plugin/axios';\nimport UserModel from '@/lin/model/user';\nimport Utils from '@/lin/util/util';\nimport Config from '@/config';\nexport default {\n  setup: function setup() {\n    var tag = '';\n    var wait = 2000; // 2000ms之内不能重复发起请求\n\n    var loading = ref(false);\n    var captchaImage = ref('');\n    var store = useStore();\n    var router = useRouter();\n    var throttleLogin = ref(null);\n\n    var _getCurrentInstance = getCurrentInstance(),\n        ctx = _getCurrentInstance.ctx;\n\n    var account = reactive({\n      username: '',\n      password: '',\n      captcha: ''\n    });\n    /**\n     * 根据账号密码登录，拿到 token 并储存\n     */\n\n    var login = /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        var username, password, captcha;\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                username = account.username, password = account.password, captcha = account.captcha;\n                _context.prev = 1;\n                loading.value = true;\n                _context.next = 5;\n                return UserModel.getToken(username, password, captcha, tag);\n\n              case 5:\n                _context.next = 7;\n                return getInformation();\n\n              case 7:\n                loading.value = false;\n                router.push(Config.defaultRoute);\n                ctx.$message({\n                  message: '登录成功',\n                  type: 'success'\n                });\n                _context.next = 15;\n                break;\n\n              case 12:\n                _context.prev = 12;\n                _context.t0 = _context[\"catch\"](1);\n                loading.value = false;\n\n              case 15:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[1, 12]]);\n      }));\n\n      return function login() {\n        return _ref.apply(this, arguments);\n      };\n    }();\n\n    var getCaptcha = /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                axios({\n                  method: 'POST',\n                  url: 'cms/user/captcha'\n                }).then(function (result) {\n                  ;\n                  tag = result.tag;\n                  captchaImage.value = result.image;\n                });\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      return function getCaptcha() {\n        return _ref2.apply(this, arguments);\n      };\n    }();\n    /**\n     * 获取并更新当前管理员信息\n     */\n\n\n    var getInformation = /*#__PURE__*/function () {\n      var _ref3 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {\n        var user;\n        return regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.prev = 0;\n                _context3.next = 3;\n                return UserModel.getPermissions();\n\n              case 3:\n                user = _context3.sent;\n                store.dispatch('setUserAndState', user);\n                store.commit('SET_USER_PERMISSIONS', user.permissions);\n                _context3.next = 11;\n                break;\n\n              case 8:\n                _context3.prev = 8;\n                _context3.t0 = _context3[\"catch\"](0);\n                console.error(_context3.t0);\n\n              case 11:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, null, [[0, 8]]);\n      }));\n\n      return function getInformation() {\n        return _ref3.apply(this, arguments);\n      };\n    }();\n    /**\n     * 节流登录\n     */\n\n\n    onMounted(function () {\n      getCaptcha();\n      throttleLogin.value = Utils.throttle(login, wait);\n    });\n    return {\n      account: account,\n      loading: loading,\n      captchaImage: captchaImage,\n      throttleLogin: throttleLogin\n    };\n  }\n};","map":{"version":3,"sources":["/Users/zhahn/Documents/Hahn/自考/项目/mall_cms/src/view/login/login.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div class=\"login\">\n    <div class=\"team-name hidden-sm-and-down\"><img src=\"@/assets/image/login/team-name.png\" alt=\"logo\" /></div>\n    <div class=\"form-box\" v-loading=\"loading\" element-loading-background=\"rgba(0, 0, 0, 0)\">\n      <div class=\"title\"><h1 title=\"Lin\">Lin CMS</h1></div>\n      <form class=\"login-form\" autocomplete=\"off\" @submit.prevent=\"throttleLogin()\">\n        <div class=\"form-item nickname\">\n          <span class=\"icon account-icon\"></span>\n          <input type=\"text\" v-model=\"account.username\" autocomplete=\"off\" placeholder=\"请填写用户名\" />\n        </div>\n        <div class=\"form-item password\">\n          <span class=\"icon secret-icon\"></span>\n          <input type=\"password\" v-model=\"account.password\" autocomplete=\"off\" placeholder=\"请填写用户登录密码\" />\n        </div>\n        <div class=\"form-item password\" v-if=\"captchaImage\">\n          <img class=\"captcha\" :src=\"captchaImage\" />\n          <input type=\"password\" v-model=\"account.captcha\" autocomplete=\"off\" placeholder=\"请填写验证码\" />\n        </div>\n        <button class=\"submit-btn\" type=\"submit\">登录</button>\n      </form>\n    </div>\n  </div>\n</template>\n\n<script>\nimport { reactive, ref, onMounted, getCurrentInstance } from 'vue'\nimport { useStore } from 'vuex'\nimport { useRouter } from 'vue-router'\nimport axios from 'lin/plugin/axios'\nimport UserModel from '@/lin/model/user'\nimport Utils from '@/lin/util/util'\nimport Config from '@/config'\n\nexport default {\n  setup() {\n    let tag = ''\n    const wait = 2000 // 2000ms之内不能重复发起请求\n    const loading = ref(false)\n    const captchaImage = ref('')\n    const store = useStore()\n    const router = useRouter()\n    const throttleLogin = ref(null)\n    const { ctx } = getCurrentInstance()\n\n    const account = reactive({\n      username: '',\n      password: '',\n      captcha: '',\n    })\n\n    /**\n     * 根据账号密码登录，拿到 token 并储存\n     */\n    const login = async () => {\n      const { username, password, captcha } = account\n      try {\n        loading.value = true\n        await UserModel.getToken(username, password, captcha, tag)\n        await getInformation()\n        loading.value = false\n        router.push(Config.defaultRoute)\n        ctx.$message({\n          message: '登录成功',\n          type: 'success',\n        })\n      } catch (e) {\n        loading.value = false\n      }\n    }\n\n    const getCaptcha = async () => {\n      axios({\n        method: 'POST',\n        url: 'cms/user/captcha',\n      }).then(result => {\n        ;({ tag } = result)\n        captchaImage.value = result.image\n      })\n    }\n\n    /**\n     * 获取并更新当前管理员信息\n     */\n    const getInformation = async () => {\n      try {\n        // 尝试获取当前用户信息\n        const user = await UserModel.getPermissions()\n        store.dispatch('setUserAndState', user)\n        store.commit('SET_USER_PERMISSIONS', user.permissions)\n      } catch (e) {\n        console.error(e)\n      }\n    }\n\n    /**\n     * 节流登录\n     */\n    onMounted(() => {\n      getCaptcha()\n      throttleLogin.value = Utils.throttle(login, wait)\n    })\n\n    return {\n      account,\n      loading,\n      captchaImage,\n      throttleLogin,\n    }\n  },\n}\n</script>\n\n<style lang=\"scss\">\n.login {\n  width: 100%;\n  height: 100%;\n  background-size: auto;\n  background: #1b2c5f url('../../assets/image/login/login-ba.png') no-repeat center center;\n\n  .team-name {\n    position: fixed;\n    left: 40px;\n    top: 50%;\n    width: 50px;\n    transform: translateY(-50%);\n  }\n\n  .form-box {\n    position: fixed;\n    left: 50%;\n    top: 50%;\n    transform: translate(-50%, -50%);\n    width: 445px;\n\n    .title {\n      height: 37px;\n      font-size: 30px;\n      line-height: 37px;\n      margin-bottom: 15%;\n\n      h1 {\n        padding-left: 74px;\n        box-sizing: border-box;\n        text-align: left;\n        color: #8c98ae;\n      }\n    }\n\n    .login-form {\n      width: 100%;\n\n      .form-item {\n        position: relative;\n        width: 100%;\n        height: 40px;\n        box-sizing: border-box;\n        padding-bottom: 13px;\n        margin-bottom: 34px;\n\n        input {\n          width: 100%;\n          height: 100%;\n          background: transparent;\n          color: #c4c9d2;\n          font-size: 14px;\n          padding-left: 74px;\n          box-sizing: border-box;\n        }\n\n        .captcha {\n          position: absolute;\n          width: 80px;\n          right: 30px;\n          top: -22px;\n        }\n      }\n\n      .form-item.nickname {\n        background: url('../../assets/image/login/nickname.png') no-repeat;\n        background-size: 100% auto;\n        background-position: left bottom;\n      }\n\n      .form-item.password {\n        background: url('../../assets/image/login/password.png') no-repeat;\n        background-size: 100% auto;\n        background-position: left bottom;\n      }\n\n      .submit-btn {\n        width: 100%;\n        height: 70px;\n        color: #c4c9d2;\n        font-size: 16px;\n        text-align: left;\n        box-sizing: border-box;\n        padding: 0 10px;\n        padding-left: 74px;\n        background: url('../../assets/image/login/login-btn.png') no-repeat;\n        background-size: 90% auto;\n        background-position: center bottom;\n        border: none;\n        cursor: pointer;\n      }\n    }\n  }\n}\n</style>\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}